<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAvOR7GVNRjoSHwRlmiJsMptnodnlhTL-k",
  authDomain: "agonibarber.firebaseapp.com",
  projectId: "agonibarber",
  storageBucket: "agonibarber.firebasestorage.app",
  messagingSenderId: "195737259673",
  appId: "1:195737259673:web:a129ea0024d0802e173208"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const dateInput = document.getElementById("date");
const timeSelect = document.getElementById("time");

const allTimes = [
"09:00","09:30","10:00","10:30","11:00","11:30",
"12:00","13:00","14:00","15:00","16:00"
];

dateInput.addEventListener("change", async () => {

  const selectedDate = dateInput.value;

  const q = query(
    collection(db,"appointments"),
    where("date","==",selectedDate)
  );

  const querySnapshot = await getDocs(q);

  const takenTimes = [];
  querySnapshot.forEach(doc=>{
    takenTimes.push(doc.data().time);
  });

  timeSelect.innerHTML="";

  allTimes.forEach(time=>{
    if(!takenTimes.includes(time)){
      const option=document.createElement("option");
      option.value=time;
      option.textContent=time;
      timeSelect.appendChild(option);
    }
  });

});

window.reserve = async function(){

  const service = document.getElementById("service").value;
  const date = dateInput.value;
  const time = timeSelect.value;
  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const message = document.getElementById("message");

  if(!date || !name || !phone){
    message.innerHTML="Plotëso të gjitha fushat!";
    message.className="message error";
    return;
  }

  await addDoc(collection(db,"appointments"),{
    service,
    date,
    time,
    name,
    phone,
    createdAt:new Date()
  });

  message.innerHTML="Rezervimi u krye me sukses!";
  message.className="message success";

  dateInput.dispatchEvent(new Event("change"));
}

</script>
